<!-- path: src/main/resources/templates/admin/fragments/ajax.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<body th:fragment="productsScripts">
<script>
var GQL_ENDPOINT = '/graphql';

/* ---------- helpers ---------- */
function qs(s, r){ return (r||document).querySelector(s); }
function $id(id){ return document.getElementById(id); }
function getVal(id){ var el=$id(id); return el && el.value ? String(el.value).trim() : ''; }
function num(id){
  var v = getVal(id);
  return v === '' ? null : Number(v);
}
function toast(msg){
  var t=$id('toast'); if(!t) return;
  t.textContent=msg; t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); },1500);
}

/* B3 (tối thiểu): hiển thị lỗi GraphQL vào #errorBox thay vì alert */
function showGraphQLError(errors){
  var box = $id('errorBox');
  var list = Array.isArray(errors) ? errors : [];
  var msg = list.map(function(e){ return e && e.message ? e.message : ''; }).join('\n');
  if (!msg) msg = 'Unknown error';
  if (box){
    box.style.display='block';
    box.textContent = msg;
  } else {
    alert('GraphQL error: ' + msg);
  }
}

function gql(query, variables){
  if (!variables) variables = {};
  return fetch(GQL_ENDPOINT, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ query: query, variables: variables })
  })
  .then(function(res){ return res.json(); })
  .then(function(json){
    if (json.errors){ console.error(json.errors); showGraphQLError(json.errors); throw new Error(JSON.stringify(json.errors)); }
    return json.data;
  });
}

/* ---------- PRODUCTS ---------- */
function renderProducts(rows) {
  var tb = qs('#tbl tbody');
  var html = '';
  (rows || []).forEach(function(p){
    var pid   = (p && p.id)!=null ? p.id : '';
    var title = p && p.title ? p.title : '';
    var qty   = (p && p.quantity)!=null ? p.quantity : '';
    var price = (p && p.price)!=null ? p.price : '';
    var userId = (p && p.user && p.user.id)!=null ? p.user.id : '';
    var userName = p && p.user ? (p.user.fullname ? p.user.fullname : (p.user.email ? p.user.email : '')) : '';
    var catId  = (p && p.category && p.category.id)!=null ? p.category.id : '';
    var catName= p && p.category ? (p.category.name ? p.category.name : '') : '';
    var desc  = p && p.desc ? p.desc : '';

    html += ''
      + '<tr'
      + ' data-id="'+pid+'"'
      + ' data-title="'+title+'"'
      + ' data-qty="'+qty+'"'
      + ' data-price="'+price+'"'
      + ' data-user="'+userId+'"'
      + ' data-cat="'+catId+'"'
      + ' data-desc="'+desc+'">'
      +   '<td>'+pid+'</td>'
      +   '<td>'+title+'</td>'
      +   '<td>'+qty+'</td>'
      +   '<td>'+price+'</td>'
      +   '<td>'+userName+'</td>'
      +   '<td>'+catName+'</td>'
      + '</tr>';
  });
  tb.innerHTML = html;

  var trs = tb.querySelectorAll('tr');
  for (var i=0;i<trs.length;i++){
    (function(tr){
      tr.addEventListener('click', function(){
        $id('p_id').value    = tr.getAttribute('data-id')   || '';
        $id('p_title').value = tr.getAttribute('data-title')|| '';
        $id('p_qty').value   = tr.getAttribute('data-qty')  || '';
        $id('p_price').value = tr.getAttribute('data-price')|| '';
        $id('p_user').value  = tr.getAttribute('data-user') || '';
        $id('p_cat').value   = tr.getAttribute('data-cat')  || '';
        $id('p_desc').value  = tr.getAttribute('data-desc') || '';
        toast('Loaded product #' + (tr.getAttribute('data-id') || ''));
      });
    })(trs[i]);
  }
}

function loadAllAsc() {
  var q = "query {"
        + "  productsSortedByPriceAsc { id title quantity price user{ id fullname } category{ id name } }"
        + "}";
  return gql(q).then(function(data){
    renderProducts(data.productsSortedByPriceAsc);
  });
}

function loadByCategory() {
  var catId = Number(($id('categoryId').value || 1));
  var q = "query($cid: ID!){"
        + "  productsByCategory(categoryId:$cid){ id title quantity price user{ id fullname } category{ id name } }"
        + "}";
  return gql(q, { cid: catId }).then(function(data){
    renderProducts(data.productsByCategory);
  });
}

function readProductInput(partial){
  if (partial!==true) partial=false;
  var v = {
    title: (getVal('p_title') || null),
    quantity: num('p_qty'),
    desc: (getVal('p_desc') || null),
    price: (getVal('p_price')==='' ? null : parseFloat(getVal('p_price'))),
    userId: num('p_user'),
    categoryId: num('p_cat')
  };
  if (!partial){
    if(!v.title){ alert('Title is required'); return null; }
    if(v.price==null || isNaN(v.price)){ alert('Price is required'); return null; }
    if(v.categoryId==null){ alert('CategoryId is required'); return null; }
  }
  return v;
}

function createProduct() {
  var v = readProductInput(false); if(!v) return;
  var q = "mutation($input: ProductInput!){ createProduct(input:$input){ id } }";
  gql(q, { input: v })
    .then(function(){ return loadAllAsc(); })
    .then(function(){ toast('Product created'); clearProductForm(); });
}

function updateProduct() {
  var id = num('p_id'); if(id==null) return alert('ID is required for update');
  var v = readProductInput(true);
  var q = "mutation($id: ID!, $input: ProductInput!){ updateProduct(id:$id, input:$input){ id } }";
  gql(q, { id: id, input: v })
    .then(function(){ return loadAllAsc(); })
    .then(function(){ toast('Product updated'); });
}

function deleteProduct() {
  var id = num('p_id'); if(id==null) return alert('ID is required for delete');
  if(!confirm('Delete product #' + id + '?')) return;
  var q = "mutation($id: ID!){ deleteProduct(id:$id) }";
  gql(q, { id: id })
    .then(function(){ return loadAllAsc(); })
    .then(function(){ toast('Product deleted'); clearProductForm(); });
}

function clearProductForm(){
  ['p_id','p_title','p_qty','p_price','p_user','p_cat','p_desc'].forEach(function(i){
    var el=$id(i); if(el) el.value='';
  });
}

/* ---------- CATEGORIES (LIST + form binding) ---------- */
function renderCategories(rows){
  var tb = qs('#tblCat tbody');
  var html = '';
  (rows||[]).forEach(function(c){
    var id = (c && c.id)!=null ? c.id : '';
    var name = c && c.name ? c.name : '';
    var img = c && c.images ? c.images : '';
    html += ''
      + '<tr data-id="'+id+'" data-name="'+name+'" data-img="'+img+'">'
      +   '<td>'+id+'</td>'
      +   '<td>'+name+'</td>'
      +   '<td>'+img+'</td>'
      + '</tr>';
  });
  tb.innerHTML = html;

  var trs = tb.querySelectorAll('tr');
  for (var i=0;i<trs.length;i++){
    (function(tr){
      tr.addEventListener('click', function(){
        $id('c_id').value   = tr.getAttribute('data-id')   || '';
        $id('c_name').value = tr.getAttribute('data-name') || '';
        $id('c_img').value  = tr.getAttribute('data-img')  || '';
        toast('Loaded category #' + (tr.getAttribute('data-id') || ''));
      });
    })(trs[i]);
  }
}

function loadCategories(){
  var q="query{ categories{ id name images } }";
  return gql(q).then(function(data){
    renderCategories(data.categories);
  });
}

function createCategory(){
  var name=getVal('c_name'); if(!name) return alert('Name is required');
  var q="mutation($in:CategoryInput!){ createCategory(input:$in){ id } }";
  gql(q,{ in:{ name: name, images:getVal('c_img') }})
    .then(function(){ return loadCategories(); })
    .then(function(){ toast('Category created'); });
}

function updateCategory(){
  var id=num('c_id'); if(id==null) return alert('ID is required for update');
  var q="mutation($id:ID!,$in:CategoryInput!){ updateCategory(id:$id,input:$in){ id } }";
  gql(q,{ id: id, in:{ name:(getVal('c_name')||null), images:(getVal('c_img')||null) }})
    .then(function(){ return loadCategories(); })
    .then(function(){ toast('Category updated'); });
}

function deleteCategory(){
  var id=num('c_id'); if(id==null) return alert('ID is required for delete');
  if(!confirm('Delete category #'+id+'?')) return;
  var q="mutation($id:ID!){ deleteCategory(id:$id) }";
  gql(q,{ id: id })
    .then(function(){ return loadCategories(); })
    .then(function(){ toast('Category deleted'); });
}

/* ---------- USERS (LIST + form binding) ---------- */
function renderUsers(rows){
  var tb = qs('#tblUser tbody');
  var html = '';
  (rows||[]).forEach(function(u){
    var id = (u && u.id)!=null ? u.id : '';
    var fullname = u && u.fullname ? u.fullname : '';
    var email = u && u.email ? u.email : '';
    var phone = u && u.phone ? u.phone : '';
    html += ''
      + '<tr data-id="'+id+'" data-fullname="'+fullname+'" data-email="'+email+'" data-phone="'+phone+'">'
      +   '<td>'+id+'</td>'
      +   '<td>'+fullname+'</td>'
      +   '<td>'+email+'</td>'
      +   '<td>'+phone+'</td>'
      + '</tr>';
  });
  tb.innerHTML = html;

  var trs = tb.querySelectorAll('tr');
  for (var i=0;i<trs.length;i++){
    (function(tr){
      tr.addEventListener('click', function(){
        $id('u_id').value       = tr.getAttribute('data-id') || '';
        $id('u_fullname').value = tr.getAttribute('data-fullname') || '';
        $id('u_email').value    = tr.getAttribute('data-email') || '';
        $id('u_phone').value    = tr.getAttribute('data-phone') || '';
        $id('u_pass').value     = '';
        toast('Loaded user #' + (tr.getAttribute('data-id') || ''));
      });
    })(trs[i]);
  }
}

function loadUsers(){
  var q="query{ users{ id fullname email phone } }";
  return gql(q).then(function(data){
    renderUsers(data.users);
  });
}

function createUser(){
  var email=getVal('u_email'); if(!email) return alert('Email is required');
  var q="mutation($in:UserInput!){ createUser(input:$in){ id } }";
  gql(q,{ in:{ fullname:getVal('u_fullname'), email:email, password:getVal('u_pass'), phone:getVal('u_phone') }})
    .then(function(){ return loadUsers(); })
    .then(function(){ toast('User created'); });
}

function updateUser(){
  var id=num('u_id'); if(id==null) return alert('ID is required for update');
  var q="mutation($id:ID!,$in:UserInput!){ updateUser(id:$id,input:$in){ id } }";
  gql(q,{ id:id, in:{ fullname:(getVal('u_fullname')||null), email:(getVal('u_email')||null), password:(getVal('u_pass')||null), phone:(getVal('u_phone')||null) }})
    .then(function(){ return loadUsers(); })
    .then(function(){ toast('User updated'); });
}

function deleteUser(){
  var id=num('u_id'); if(id==null) return alert('ID is required for delete');
  if(!confirm('Delete user #'+id+'?')) return;
  var q="mutation($id:ID!){ deleteUser(id:$id) }";
  gql(q,{ id:id })
    .then(function(){ return loadUsers(); })
    .then(function(){ toast('User deleted'); });
}

/* ---------- boot ---------- */
window.addEventListener('DOMContentLoaded', function () {
  // product
  $id('btnLoad').addEventListener('click', loadAllAsc);
  $id('btnByCat').addEventListener('click', loadByCategory);
  $id('btnPCreate').addEventListener('click', createProduct);
  $id('btnPUpdate').addEventListener('click', updateProduct);
  $id('btnPDelete').addEventListener('click', deleteProduct);
  $id('btnPClear').addEventListener('click', function(){ clearProductForm(); });

  // category
  $id('btnCatReload').addEventListener('click', loadCategories);
  $id('btnCCreate').addEventListener('click', createCategory);
  $id('btnCUpdate').addEventListener('click', updateCategory);
  $id('btnCDelete').addEventListener('click', deleteCategory);

  // user
  $id('btnUserReload').addEventListener('click', loadUsers);
  $id('btnUCreate').addEventListener('click', createUser);
  $id('btnUUpdate').addEventListener('click', updateUser);
  $id('btnUDelete').addEventListener('click', deleteUser);

  // initial loads
  loadAllAsc();
  loadCategories();
  loadUsers();
});
</script>
</body>
</html>
